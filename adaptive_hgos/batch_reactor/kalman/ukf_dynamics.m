function dstate = ukf_dynamics(state, a, b, k, R, Q)

n = 3;
C = [(821/25), (821/25), (821/25)];

x = state(1:n);
m = state((n + 1):(2 * n));
P = state((2 * n + 1):(2 * n + n^2));

P = reshape(P, [n, n]);

dx = [
    (-1/2).*x(1)+(1/20).*x(2).*x(3);
    (1/2).*x(1)+(-2/5).*x(2).^2+(1/50).*x(3)+(-1/20).*x(2).*x(3);
    (1/2).*x(1)+(1/5).*x(2).^2+(-1/100).*x(3)+(-1/20).*x(2).*x(3);
];

y = C * x;

sqP = sqrtm(P);

c = a^2 * (n + k);
l = a^2 * (n + k) - n;

Wm = [l / (n + l); repmat(1 / (2 * (n + l)), 2 * n, 1)];
Wc = [l / (n + l) + (1 - a^2  + b); repmat(1 / (2 * (n + l)), 2 * n, 1)];
W = (eye(2 * n + 1) - repmat(Wm, 1, 2 * n + 1)) * diag(Wc) * ...
    (eye(2 * n + 1) - repmat(Wm, 1, 2 * n + 1))';

X = repmat(m, 1, 2 * n + 1) + sqrt(c) * [zeros(n, 1), sqP, -sqP];

Y = C * X;

K = X * W * Y' / R;

fm = [
    (-1/2).*m(1)+(1/20).*m(2).*m(3);
    (1/2).*m(1)+(-2/5).*m(2).^2+(1/50).*m(3)+(-1/20).*m(2).*m(3);
    (1/2).*m(1)+(1/5).*m(2).^2+(-1/100).*m(3)+(-1/20).*m(2).*m(3);
];
ym = C * m;

dm = fm + K * (y - ym);

f = [
    (-1/2).*X(1,:)+(1/20).*X(2,:).*X(3,:);
    (1/2).*X(1,:)+(-2/5).*X(2,:).^2+(1/50).*X(3,:)+(-1/20).*X(2,:).*X(3,:);
    (1/2).*X(1,:)+(1/5).*X(2,:).^2+(-1/100).*X(3,:)+(-1/20).*X(2,:).*X(3,:);
];

dP = X * W * f' + f * W * X' + Q - K * R * K';

dstate = [dx; dm; dP(:)];
